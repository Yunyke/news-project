<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ğŸ“° æ–°èç‰†</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
	<link rel="stylesheet" th:href="@{/css/cart.css}">
<style>

</style>
</head>

<body th:attr="data-user-id=${userId}" id="user-cart">

	<div
		style="position: absolute; top: 5px; right: 20px; z-index: 1050; background-color: #f8f9fa; padding: 5px 10px; border-radius: 8px; color: #6c757d;">
		<a class="btn btn-sm btn-outline-light me-2 custom-auth-btn" href="/">å›é¦–é </a>
		<a class="btn btn-sm btn-outline-light custom-auth-btn" href="/logout">ç™»å‡º</a>
	</div>

	<!-- æ”¶è—æ¸…å–® -->
	<nav id="favorite-list">
		<h5>â­ æ”¶è—æ¸…å–®</h5>
		<ul class="sidebar-list" id="favorite-list-ul">
			
		</ul>
	</nav>

	<!-- å·¦å´ç›®éŒ„ -->
	<nav id="sidebar-nav">
		
	</nav>

	<main class="feed-container">
		<h1 class="text-center mb-4">ğŸ“° æˆ‘çš„æ–°èç‰†</h1>

		<div id="cart-content">	</div>
	</main>

	<script>function loadFavoriteList(userId) {
		  fetch(`/favorites?userId=${userId}`)
		    .then(res => res.json())
		    .then(favorites => {
		      const favList = document.getElementById("favorite-list-ul");
		      favList.innerHTML = ""; // æ¸…ç©ºå†é‡æ–°æ¸²æŸ“

		      favorites.forEach(item => {
		          const li = document.createElement("li");
		          li.className = "sidebar-item d-flex justify-content-between align-items-center";
		          li.setAttribute("data-news-id", item.newsId);
				
		        const link = document.createElement("a");
		        link.href = item.url || "#";  
		        link.target = "_blank";       
		        link.textContent = item.title || "æœªå‘½åæ–°è";
		        link.title = item.title;
				
		        const removeBtn = document.createElement("span");
		        removeBtn.textContent = "âŒ ";
		        removeBtn.style.cursor = "pointer";
		        removeBtn.title = "ç§»é™¤æ”¶è—";
		        removeBtn.classList.add("text-danger", "me-1");

		        removeBtn.onclick = () => {
		          if (!confirm("ç¢ºå®šè¦ç§»é™¤é€™å‰‡æ”¶è—å—ï¼Ÿ")) return;

		          fetch(`/favorites/${item.newsId}?userId=${userId}`, {
		            method: "DELETE"
		          })
		          .then(res => {
		            if (!res.ok) throw new Error("ç§»é™¤å¤±æ•—");
		            li.remove();
		            console.log(`ğŸ—‘ï¸ å·²ç§»é™¤æ”¶è—ï¼š${item.newsId}`);
		            loadCart(userId); 
		          })
		          .catch(err => {
		            console.error("âŒ ç§»é™¤æ”¶è—å¤±æ•—", err);
		            alert("ç§»é™¤æ”¶è—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
		          });
		        };

		        const textWrap = document.createElement("div");
		        textWrap.className = "text-truncate";
		        textWrap.appendChild(link);

		        li.appendChild(textWrap);
		        li.appendChild(removeBtn);
		        favList.appendChild(li);
		      });
		    })
		    .catch(err => {
		      console.error("âŒ ç„¡æ³•è¼‰å…¥æ”¶è—æ¸…å–®", err);
		    });
		}
function syncCartToServer() {
	  const ids = JSON.parse(localStorage.getItem("newsCart") || "[]");

	  if (!Array.isArray(ids) || ids.length === 0) return;

	 
	  fetch(`/api/cart/users/${userId}/bulk`, {
	 
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify({ newsIds: ids })
	  })
	  .then(res => {
	    if (!res.ok) throw new Error("åŒæ­¥å¤±æ•—");
	    return res.text();
	  })
	  .then(msg => console.log("âœ… è³¼ç‰©è»ŠåŒæ­¥å®Œæˆ"))
	  
	  .catch(err => console.error("âŒ è³¼ç‰©è»ŠåŒæ­¥éŒ¯èª¤", err));
	}
function fetchCartFromServer(userId) {
	  return fetch(`/api/cart/users/${userId}/cart`)
	    .then(res => {
	      if (!res.ok) throw new Error("âŒ ç„¡æ³•å–å¾—ä¼ºæœå™¨æ”¶è—æ¸…å–®");
	      return res.json();
	    });
	}

const userCartEl = document.getElementById("user-cart");
const userId = parseInt(document.getElementById("user-cart").dataset.userId, 10);

if (!userId) {
	  console.warn("âš ï¸ ç„¡æ³•å–å¾— userIdï¼Œè«‹ç¢ºèªç”¨æˆ¶å·²ç™»å…¥æˆ– body æ¨™ç±¤æœ‰è¨­ç½® data-user-id");
	}
function loadCart(userId) {
	  const ids = JSON.parse(localStorage.getItem("newsCart") || "[]")
	              .filter(id => Number.isInteger(id) && id > 0);

	  if (ids.length === 0) {
	    document.getElementById("cart-content").innerHTML = `
	      <p class="text-center text-muted mt-5">ğŸ“­ æ–°èæ¸…å–®ç©ºç©ºçš„~</p>`;
	    return;
	  }

	  fetch("/cart/load", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify(ids)
	  })
	  .then(res => res.text())
	  .then(html => {
	    document.getElementById("cart-content").innerHTML = html;

    

	    document.querySelectorAll(".favorite-btn").forEach(btn => {
	        btn.addEventListener("click", function () {
	          const newsId = this.dataset.id;
	          const self = this;
	          

	         // fetch(`/favorites/${newsId}?userId=${window.USER_SESSION.userId}`, { method: "POST" })
	          fetch(`/favorites/${newsId}?userId=${userId}`, { method: "POST" })
	          .then(res => {
	        	    if (!res.ok) {
	        	        throw new Error(`HTTP ${res.status} - æ”¶è—å¤±æ•—`);
	        	      }
	        	      return res.json();
	        	    })
	          .then(data => {
	            if (data.favorited !== undefined) {
	              const icon = data.favorited ? "â¤ï¸ å·²æ”¶è—" : "ğŸ’™ æ”¶è—";
	              self.innerHTML = icon;
	              self.classList.toggle("btn-outline-success", !data.favorited);
	              self.classList.toggle("btn-outline-danger", data.favorited);

	             
	              const card = self.closest(".news-feed-card");
	              const title = card.querySelector(".news-feed-title")?.textContent || "æœªå‘½åæ–°è";
	              const url = card.getAttribute("data-url") || "#";
	              const id = card.getAttribute("id");
	              const favList = document.getElementById("favorite-list-ul");

	              if (data.favorited) {
	                const li = document.createElement("li");
	                li.className = "sidebar-item";
	                li.setAttribute("data-news-id", newsId);

	                const link = document.createElement("a");
	                link.href = url;                    
	                link.target = "_blank";             
	                link.textContent = title;
	                link.title = title;
	                
	                

	                const removeBtn = document.createElement("span");
	                removeBtn.textContent = "âŒ ";
	                removeBtn.style.cursor = "pointer";
	                removeBtn.title = "ç§»é™¤æ”¶è—";
	                removeBtn.classList.add("text-danger", "me-1");

	                removeBtn.onclick = () => {
	                  if (!confirm("ç¢ºå®šè¦ç§»é™¤é€™å‰‡æ”¶è—å—ï¼Ÿ")) return;

	                  fetch(`/favorites/${newsId}?userId=${userId}`, { method: "DELETE" })
	                    .then(res => {
	                      if (!res.ok) throw new Error("ç§»é™¤å¤±æ•—");
	                      li.remove();
	                      console.log(`ğŸ—‘ï¸ å·²ç§»é™¤æ”¶è—ï¼š${newsId}`);
	                      loadCart(userId);
	                    })
	                    .catch(err => {
	                      console.error("âŒ ç§»é™¤æ”¶è—å¤±æ•—", err);
	                      alert("ç§»é™¤æ”¶è—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
	                    });
	                };

	                const textWrap = document.createElement("div");
	                textWrap.className = "text-truncate";
	                textWrap.appendChild(link);

	                li.appendChild(textWrap);
	                li.appendChild(removeBtn);
	                favList.appendChild(li);
	              } else {
	                const itemToRemove = favList.querySelector(`li[data-news-id="${newsId}"]`);
	                if (itemToRemove) itemToRemove.remove();
	              }
	            }
	          })
	          .catch(err => {
	            console.error("æ”¶è—å¤±æ•—", err);
	            alert("âš ï¸ æ”¶è—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
	          });
	        });
	      });

    // ç§»é™¤ç„¡æ•ˆID
    const existingIds = Array.from(document.querySelectorAll(".remove-from-cart-btn"))
      .map(btn => parseInt(btn.dataset.id));

    let cartIds = JSON.parse(localStorage.getItem("newsCart") || "[]");
    const filtered = cartIds.filter(id => existingIds.includes(id));

    if (filtered.length !== cartIds.length) {
      localStorage.setItem("newsCart", JSON.stringify(filtered));
      console.warn("ğŸ§¹ å·²å¾ localStorage æ¸…é™¤ç„¡æ•ˆæ–°è IDï¼š", cartIds.filter(id => !existingIds.includes(id)));
    }

    // å·¦å´ç›®éŒ„
    const sidebar = document.getElementById("sidebar-nav");
    sidebar.innerHTML = "<h5>ğŸ“‘ æ–°èæ¸…å–®</h5><ul class='sidebar-list'></ul>";
    const list = sidebar.querySelector(".sidebar-list");

    document.querySelectorAll(".news-feed-card").forEach((card, index) => {
      const title = card.querySelector(".news-feed-title")?.textContent || `æ–°è ${index + 1}`;
      const id = `news-item-${index}`;
      card.setAttribute("id", id);

      const li = document.createElement("li");
      li.className = "sidebar-item";

      const number = document.createElement("span");
      number.className = "item-index";
      number.textContent = `${index + 1}.`;

      const link = document.createElement("a");
      link.href  = `#${card.id}`;  
      link.textContent = title;
      link.title = title;

      li.appendChild(number);
      li.appendChild(link);
      list.appendChild(li);
    });

    // ç§»é™¤æŒ‰éˆ•
    document.querySelectorAll(".remove-from-cart-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        const id = parseInt(this.dataset.id);
        let cart = JSON.parse(localStorage.getItem("newsCart") || "[]");
        cart = cart.filter(item => item !== id);
        localStorage.setItem("newsCart", JSON.stringify(cart));
        fetch(`/api/cart/users/${userId}/cart/${id}`, {
            method: "DELETE"
          }).catch(err => console.error("åˆªé™¤å¾Œç«¯ cart å¤±æ•—", err));

          loadCart(userId); // é‡æ–°è¼‰å…¥ç•«é¢
        });
    });

    // å±•é–‹å…¨æ–‡
    document.querySelectorAll(".toggle-content-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        const content = this.closest(".news-feed-card").querySelector(".news-feed-content");
        const isShown = content.style.display === "block";
        content.style.display = isShown ? "none" : "block";
        this.textContent = isShown ? "é–±è®€å…¨æ–‡" : "æ”¶èµ·å…¨æ–‡";
      });
    });
  });
}

// AI èŠå¤©è¦–çª—
function toggleChatbox() {
  const chatbox = document.getElementById("ai-chatbox");
  chatbox.style.display = (chatbox.style.display === "none" || chatbox.style.display === "") ? "flex" : "none";
}

// å‚³é€è¨Šæ¯åˆ° AI ä¸¦é¡¯ç¤ºå›è¦†
async function sendAiMessage() {
  const input = document.getElementById("ai-user-input");
  const msg = input.value.trim();
  if (!msg) return;

  const messages = document.getElementById("ai-chatbox-messages");

  const userMsg = document.createElement("div");
  userMsg.innerHTML = `<strong>ä½ :</strong> ${msg}`;
  messages.appendChild(userMsg);
  input.value = "";

  const aiReply = document.createElement("div");
  aiReply.innerHTML = `<strong>AI:</strong> â³ å›è¦†ä¸­...`;
  messages.appendChild(aiReply);
  messages.scrollTop = messages.scrollHeight;

  try {
    const res = await fetch("/api/openai/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: msg })
    });

    const reply = await res.text(); 
    aiReply.innerHTML = `<strong>AI:</strong> ${reply}`;
  } catch (err) {
    console.error("âŒ AI å›è¦†éŒ¯èª¤", err);
    aiReply.innerHTML = `<strong>AI:</strong> âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦`;
  }

  messages.scrollTop = messages.scrollHeight;
}


document.addEventListener("DOMContentLoaded", async () => {
  const userCartEl = document.getElementById("user-cart");
  const userId = parseInt(userCartEl?.dataset.userId, 10);

  if (!userId) {
    console.warn("âš ï¸ æ²’æŠ“åˆ° userIdï¼Œç™»å…¥äº†å—ï¼Ÿ");
    return;
  }

  try {
    
    const serverCart = await fetchCartFromServer(userId);

    // æ›´æ–° localStorage
    localStorage.setItem("newsCart", JSON.stringify(serverCart));

    // è¼‰å…¥ç•«é¢ä¸¦åŒæ­¥è³‡æ–™
    syncCartToServer(userId); 
    loadCart(userId);
    loadFavoriteList(userId); 
  } catch (err) {
    console.error("âŒ åˆå§‹åŒæ­¥æ”¶è—å¤±æ•—ï¼š", err);
  }
  toggleChatbox();
 

  // ç¶å®š AI è¼¸å…¥ Enter å¿«æ·éµ
  const aiInput = document.getElementById("ai-user-input");
  if (aiInput) {
    aiInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        sendAiMessage();
      }
    });
  }
});

document.addEventListener("DOMContentLoaded", () => {
	 

	  // ç™»å‡ºæ¸…é™¤ localStorage
	  const logoutBtn = document.querySelector('a[href="/logout"]');
	  if (logoutBtn) {
	    logoutBtn.addEventListener("click", function (e) {
	      e.preventDefault();
	      console.log("ğŸšª [cart.html] ä½¿ç”¨è€…ç™»å‡ºï¼Œæ¸…é™¤ localStorage.newsCart");
	      localStorage.removeItem("newsCart");
	      window.location.href = "/logout";
	    });
	  }
	});
	
document.addEventListener("click", function (e) {
  if (e.target && e.target.textContent.includes("AI é‡é»æ•´ç†")) {
    const card = e.target.closest(".news-feed-card");
    const contentEl = card.querySelector(".news-feed-content");

    if (!contentEl) {
      alert("âŒ æ‰¾ä¸åˆ°æ–°èå…§å®¹");
      return;
    }

    const contentText = contentEl.innerText.trim();
    if (!contentText) {
      alert("â— è©²æ–°èæ²’æœ‰å…§å®¹å¯ä»¥æ‘˜è¦");
      return;
    }

 
    const chatbox = document.getElementById("ai-chatbox");
    if (chatbox.style.display === "none" || chatbox.style.display === "") {
      chatbox.style.display = "flex";
    }

    // é€å‡ºæ–°èå…§å®¹çµ¦ AI
    sendAiContentToChat(contentText);
  }
});


function sendAiContentToChat(contentText) {
  const messages = document.getElementById("ai-chatbox-messages");

  const userMsg = document.createElement("div");
  userMsg.innerHTML = `<strong>ä½ :</strong> é‡é»æ•´ç†ä»¥ä¸‹æ–°èï¼š<br><div style="font-size: 0.85rem; color: #555; margin-top: 4px;">${contentText}</div>`;
  messages.appendChild(userMsg);

  const aiReply = document.createElement("div");
  aiReply.innerHTML = `<strong>AI:</strong> â³ æ­£åœ¨åˆ†æä¸­...`;
  messages.appendChild(aiReply);
  messages.scrollTop = messages.scrollHeight;

  fetch("/api/openai/ask", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },	 
	    body: JSON.stringify({ message: contentText })
	  })
	    .then(res => res.text())
	    .then(reply => {
	    	aiReply.innerHTML = `
	    		  <div class="ai-reply-block">
	    		    <strong class="ai-label">AI:</strong>
	    		    <div class="ai-content">${reply.replace(/\n/g, "<br>")}</div>
	    		  </div>`;
	      messages.scrollTop = messages.scrollHeight;
	    })
	    .catch(err => {
	      console.error("âŒ AI å›è¦†éŒ¯èª¤", err);
	      aiReply.innerHTML = `<strong>AI:</strong> âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦`;
	    });
	}

</script>

	<div th:fragment="cartFragment">
		<script th:inline="javascript">
	console.log("User ID is:", userId);
	
	
</script>

		<div th:each="news : ${cartNews}" class="news-feed-card" th:attr="data-url=${news.url}">
		
			<img th:if="${news.imageUrl}" th:src="${news.imageUrl}"
				class="news-feed-img" />

			<div class="news-feed-title" th:text="${news.title}">æ¨™é¡Œ</div>

			<div class="news-feed-desc" th:text="${news.description}">æ‘˜è¦</div>

			<div class="news-feed-time"
				th:text="${#temporals.format(news.publishedAt, 'yyyy-MM-dd HH:mm')}">æ™‚é–“</div>


			<div class="news-feed-content" th:utext="${news.content}"></div>

			<div class="news-feed-actions">
    <button class="btn btn-sm btn-outline-primary toggle-content-btn">é–±è®€å…¨æ–‡</button>
    <button class="btn btn-sm favorite-btn btn-outline-success"
        th:text="'ğŸ’™ æ”¶è—'" th:attr="data-id=${news.id}"></button>
    <button class="btn btn-sm btn-outline-danger remove-from-cart-btn"
        th:attr="data-id=${news.id}">ç§»é™¤</button>    
   
    <button class="btn btn-sm btn-outline-secondary ms-auto">AI é‡é»æ•´ç†</button>
</div>
	</div>
	</div>
	<!-- AI åŠ©ç†å°è©±æ¡† -->
	<div id="ai-chatbox">
		<div id="ai-chatbox-header">ğŸ¤– AI åŠ©ç†</div>
		<div id="ai-chatbox-messages">
			<div>
				<strong>AI:</strong> è«‹é¸æ“‡æ–°è...
			</div>
			<div id="ai-chatbox-input">
			
		</div>
		</div>
		
	</div>
	
</body>
</html>