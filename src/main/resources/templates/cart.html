<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ğŸ“° æ–°èç‰†</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet" th:href="@{/css/cart.css}">
</head>

<body th:attr="data-user-id=${userId}" id="user-cart">

	<div
		style="position: absolute; top: 5px; right: 20px; z-index: 1050; background-color: #f8f9fa; padding: 5px 10px; border-radius: 8px; color: #6c757d;">
		<a class="btn btn-sm btn-outline-light me-2 custom-auth-btn" href="/">å›é¦–é </a>
		<a class="btn btn-sm btn-outline-light custom-auth-btn" href="/logout">ç™»å‡º</a>
	</div>

	<!-- âœ… å³å´æ”¶è—æ¸…å–® -->
	<nav id="favorite-list">
		<h5>â­ æ”¶è—æ¸…å–®</h5>
		<ul class="sidebar-list" id="favorite-list-ul">
			<!-- JS å‹•æ…‹ç”¢ç”Ÿæ”¶è—æ¸…å–® -->
		</ul>
	</nav>

	<!-- âœ… å·¦å´å›ºå®šç›®éŒ„ -->
	<nav id="sidebar-nav">
		<!-- JS å‹•æ…‹æ’å…¥ç›®éŒ„é€£çµ -->
	</nav>

	<main class="feed-container">
		<h1 class="text-center mb-4">ğŸ“° æˆ‘çš„æ–°èç‰†</h1>

		<div id="cart-content">
			<!-- è«‹æ±‚è³‡æ–™å¾Œé€™è£¡æœƒè¢«å¡«æ»¿ -->
		</div>
	</main>

	<script>function loadFavoriteList(userId) {
		  fetch(`/favorites?userId=${userId}`)
		    .then(res => res.json())
		    .then(favorites => {
		      const favList = document.getElementById("favorite-list-ul");
		      favList.innerHTML = ""; // æ¸…ç©ºå†é‡æ–°æ¸²æŸ“

		      favorites.forEach(item => {
		          const li = document.createElement("li");
		          li.className = "sidebar-item d-flex justify-content-between align-items-center";
		          li.setAttribute("data-news-id", item.newsId);

		        const link = document.createElement("a");
		        link.href = "#"; // æˆ–ç›´æ¥æŒ‡å‘æ–°èé€£çµ
		        link.textContent = item.title || "æœªå‘½åæ–°è";
		        link.title = item.title;

		        const removeBtn = document.createElement("span");
		        removeBtn.textContent = "âŒ ";
		        removeBtn.style.cursor = "pointer";
		        removeBtn.title = "ç§»é™¤æ”¶è—";
		        removeBtn.classList.add("text-danger", "me-1");

		        removeBtn.onclick = () => {
		          if (!confirm("ç¢ºå®šè¦ç§»é™¤é€™å‰‡æ”¶è—å—ï¼Ÿ")) return;

		          fetch(`/favorites/${item.newsId}?userId=${userId}`, {
		            method: "DELETE"
		          })
		          .then(res => {
		            if (!res.ok) throw new Error("ç§»é™¤å¤±æ•—");
		            li.remove();
		            console.log(`ğŸ—‘ï¸ å·²ç§»é™¤æ”¶è—ï¼š${item.newsId}`);
		            loadCart(userId); // â¬…ï¸ åŒæ­¥ä¸»ç•«é¢æ”¶è—ç‹€æ…‹
		          })
		          .catch(err => {
		            console.error("âŒ ç§»é™¤æ”¶è—å¤±æ•—", err);
		            alert("ç§»é™¤æ”¶è—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
		          });
		        };

		        const textWrap = document.createElement("div");
		        textWrap.className = "text-truncate";
		        textWrap.appendChild(link);

		        li.appendChild(textWrap);
		        li.appendChild(removeBtn);
		        favList.appendChild(li);
		      });
		    })
		    .catch(err => {
		      console.error("âŒ ç„¡æ³•è¼‰å…¥æ”¶è—æ¸…å–®", err);
		    });
		}
function syncCartToServer() {
	  const ids = JSON.parse(localStorage.getItem("newsCart") || "[]");

	  if (!Array.isArray(ids) || ids.length === 0) return;

	  // å‘¼å«å¾Œç«¯ APIï¼ŒæŠŠå¤šå€‹ newsId ä¸€æ¬¡é€å‡º
	  fetch(`/api/cart/users/${userId}/bulk`, {
	 
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify({ newsIds: ids })
	  })
	  .then(res => {
	    if (!res.ok) throw new Error("åŒæ­¥å¤±æ•—");
	    return res.text();
	  })
	  .then(msg => console.log("âœ… è³¼ç‰©è»ŠåŒæ­¥å®Œæˆ"))
	  
	  .catch(err => console.error("âŒ è³¼ç‰©è»ŠåŒæ­¥éŒ¯èª¤", err));
	}
function fetchCartFromServer(userId) {
	  return fetch(`/api/cart/users/${userId}/cart`)
	    .then(res => {
	      if (!res.ok) throw new Error("âŒ ç„¡æ³•å–å¾—ä¼ºæœå™¨æ”¶è—æ¸…å–®");
	      return res.json();
	    });
	}

const userCartEl = document.getElementById("user-cart");
const userId = parseInt(document.getElementById("user-cart").dataset.userId, 10);
const GEMINI_API_KEY = "AIzaSyAe55d1a9eVeG_X5PWnyJEVGcXJTDpBr6I"; // é‡‘é‘°
if (!userId) {
	  console.warn("âš ï¸ ç„¡æ³•å–å¾— userIdï¼Œè«‹ç¢ºèªç”¨æˆ¶å·²ç™»å…¥æˆ– body æ¨™ç±¤æœ‰è¨­ç½® data-user-id");
	}
function loadCart(userId) {
	  const ids = JSON.parse(localStorage.getItem("newsCart") || "[]")
	              .filter(id => Number.isInteger(id) && id > 0);

	  if (ids.length === 0) {
	    document.getElementById("cart-content").innerHTML = `
	      <p class="text-center text-muted mt-5">ğŸ“­ ç›®å‰æ²’æœ‰æ”¶è—æ–°è</p>`;
	    return;
	  }

	  fetch("/cart/load", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify(ids)
	  })
	  .then(res => res.text())
	  .then(html => {
	    document.getElementById("cart-content").innerHTML = html;

    

	    document.querySelectorAll(".favorite-btn").forEach(btn => {
	        btn.addEventListener("click", function () {
	          const newsId = this.dataset.id;
	          const self = this;
	          

	         // fetch(`/favorites/${newsId}?userId=${window.USER_SESSION.userId}`, { method: "POST" })
	          fetch(`/favorites/${newsId}?userId=${userId}`, { method: "POST" })
	          .then(res => {
	        	    if (!res.ok) {
	        	        throw new Error(`HTTP ${res.status} - æ”¶è—å¤±æ•—`);
	        	      }
	        	      return res.json();
	        	    })
	          .then(data => {
	            if (data.favorited !== undefined) {
	              const icon = data.favorited ? "â¤ï¸ å·²æ”¶è—" : "ğŸ’™ æ”¶è—";
	              self.innerHTML = icon;
	              self.classList.toggle("btn-outline-success", !data.favorited);
	              self.classList.toggle("btn-outline-danger", data.favorited);

	              // ğŸ‘‰ åŒæ­¥å³å´æ¸…å–®
	              const card = self.closest(".news-feed-card");
	              const title = card.querySelector(".news-feed-title")?.textContent || "æœªå‘½åæ–°è";
	              const url = card.getAttribute("data-url") || "#";
	              const id = card.getAttribute("id");
	              const favList = document.getElementById("favorite-list-ul");

	              if (data.favorited) {
	                const li = document.createElement("li");
	                li.className = "sidebar-item";
	                li.setAttribute("data-news-id", newsId);

	                const link = document.createElement("a");
	                link.href = url;                     // â­ æŒ‡å‘åŸå§‹æ–°èç¶²å€
	                link.target = "_blank";             // â­ åœ¨æ–°è¦–çª—é–‹å•Ÿ
	                link.textContent = title;
	                link.title = title;

	                li.appendChild(link);
	                favList.appendChild(li);
	              } else {
	                const itemToRemove = favList.querySelector(`li[data-news-id="${newsId}"]`);
	                if (itemToRemove) itemToRemove.remove();
	              }
	            }
	          })
	          .catch(err => {
	            console.error("æ”¶è—å¤±æ•—", err);
	            alert("âš ï¸ æ”¶è—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
	          });
	        });
	      });

    // âœ… ç§»é™¤ localStorage ç„¡æ•ˆ ID
    const existingIds = Array.from(document.querySelectorAll(".remove-from-cart-btn"))
      .map(btn => parseInt(btn.dataset.id));

    let cartIds = JSON.parse(localStorage.getItem("newsCart") || "[]");
    const filtered = cartIds.filter(id => existingIds.includes(id));

    if (filtered.length !== cartIds.length) {
      localStorage.setItem("newsCart", JSON.stringify(filtered));
      console.warn("ğŸ§¹ å·²å¾ localStorage æ¸…é™¤ç„¡æ•ˆæ–°è IDï¼š", cartIds.filter(id => !existingIds.includes(id)));
    }

    // âœ… ç”¢ç”Ÿå·¦å´ç›®éŒ„
    const sidebar = document.getElementById("sidebar-nav");
    sidebar.innerHTML = "<h5>ğŸ“‘ æ–°èæ¸…å–®</h5><ul class='sidebar-list'></ul>";
    const list = sidebar.querySelector(".sidebar-list");

    document.querySelectorAll(".news-feed-card").forEach((card, index) => {
      const title = card.querySelector(".news-feed-title")?.textContent || `æ–°è ${index + 1}`;
      const id = `news-item-${index}`;
      card.setAttribute("id", id);

      const li = document.createElement("li");
      li.className = "sidebar-item";

      const number = document.createElement("span");
      number.className = "item-index";
      number.textContent = `${index + 1}.`;

      const link = document.createElement("a");
      link.href  = `#${card.id}`;  
      link.textContent = title;
      link.title = title;

      li.appendChild(number);
      li.appendChild(link);
      list.appendChild(li);
    });

    // âœ… ç¶å®šç§»é™¤æŒ‰éˆ•
    document.querySelectorAll(".remove-from-cart-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        const id = parseInt(this.dataset.id);
        let cart = JSON.parse(localStorage.getItem("newsCart") || "[]");
        cart = cart.filter(item => item !== id);
        localStorage.setItem("newsCart", JSON.stringify(cart));
        fetch(`/api/cart/users/${userId}/cart/${id}`, {
            method: "DELETE"
          }).catch(err => console.error("åˆªé™¤å¾Œç«¯ cart å¤±æ•—", err));

          loadCart(userId); // é‡æ–°è¼‰å…¥ç•«é¢
        });
    });

    // âœ… ç¶å®šå±•é–‹å…¨æ–‡
    document.querySelectorAll(".toggle-content-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        const content = this.closest(".news-feed-card").querySelector(".news-feed-content");
        const isShown = content.style.display === "block";
        content.style.display = isShown ? "none" : "block";
        this.textContent = isShown ? "é–±è®€å…¨æ–‡" : "æ”¶èµ·å…¨æ–‡";
      });
    });
  });
}

// âœ… é–‹é—œ AI èŠå¤©è¦–çª—
function toggleChatbox() {
  const chatbox = document.getElementById("ai-chatbox");
  chatbox.style.display = (chatbox.style.display === "none" || chatbox.style.display === "") ? "flex" : "none";
}

// âœ… å‚³é€è¨Šæ¯åˆ° Gemini ä¸¦é¡¯ç¤ºå›è¦†
async function sendAiMessage() {
  const input = document.getElementById("ai-user-input");
  const msg = input.value.trim();
  if (!msg) return;

  const messages = document.getElementById("ai-chatbox-messages");

  // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
  const userMsg = document.createElement("div");
  userMsg.innerHTML = `<strong>ä½ :</strong> ${msg}`;
  messages.appendChild(userMsg);
  input.value = "";

  // é¡¯ç¤º loading
  const aiReply = document.createElement("div");
  aiReply.innerHTML = `<strong>AI:</strong> â³ å›è¦†ä¸­...`;
  messages.appendChild(aiReply);
  messages.scrollTop = messages.scrollHeight;

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: msg }] }]
      })
    });

    const data = await res.json();
    const replyText = data.candidates?.[0]?.content?.parts?.[0]?.text || "âš ï¸ ç„¡æ³•å–å¾—å›æ‡‰";

    aiReply.innerHTML = `<strong>AI:</strong> ${replyText}`;
  } catch (err) {
    console.error("Gemini API éŒ¯èª¤ï¼š", err);
    aiReply.innerHTML = `<strong>AI:</strong> âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦`;
  }

  messages.scrollTop = messages.scrollHeight;
}

// âœ… ç¶å®š Enter éµé€å‡º
document.addEventListener("DOMContentLoaded", async () => {
  const userCartEl = document.getElementById("user-cart");
  const userId = parseInt(userCartEl?.dataset.userId, 10);

  if (!userId) {
    console.warn("âš ï¸ æ²’æŠ“åˆ° userIdï¼Œç™»å…¥äº†å—ï¼Ÿ");
    return;
  }

  try {
    // âœ… 1. å¾å¾Œç«¯æ’ˆå›ä½¿ç”¨è€…æ”¶è—
    const serverCart = await fetchCartFromServer(userId);

    // âœ… 2. æ›´æ–° localStorage
    localStorage.setItem("newsCart", JSON.stringify(serverCart));

    // âœ… 3. è¼‰å…¥ç•«é¢ä¸¦åŒæ­¥è³‡æ–™
    syncCartToServer(userId); // å¦‚æœæƒ³åŒæ­¥åˆ° DBï¼ˆå¯ä¿ç•™ï¼‰
    loadCart(userId);
    loadFavoriteList(userId); 
  } catch (err) {
    console.error("âŒ åˆå§‹åŒæ­¥æ”¶è—å¤±æ•—ï¼š", err);
  }

 

  // ç¶å®š AI è¼¸å…¥ Enter å¿«æ·éµ
  const aiInput = document.getElementById("ai-user-input");
  if (aiInput) {
    aiInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        sendAiMessage();
      }
    });
  }
});

document.addEventListener("DOMContentLoaded", () => {
	  // å…¶ä»–åˆå§‹åŒ–é‚è¼¯â€¦

	  // âœ… â¬‡ï¸ åŠ å…¥ç™»å‡ºæ¸…é™¤ localStorage çš„é‚è¼¯
	  const logoutBtn = document.querySelector('a[href="/logout"]');
	  if (logoutBtn) {
	    logoutBtn.addEventListener("click", function (e) {
	      e.preventDefault();
	      console.log("ğŸšª [cart.html] ä½¿ç”¨è€…ç™»å‡ºï¼Œæ¸…é™¤ localStorage.newsCart");
	      localStorage.removeItem("newsCart");
	      window.location.href = "/logout";
	    });
	  }
	});
</script>


	<!-- Thymeleaf Fragment for cart -->
	<div th:fragment="cartFragment">
		<script th:inline="javascript">
	console.log("User ID is:", userId);
	
	
</script>

		<div th:each="news : ${cartNews}" class="news-feed-card" th:attr="data-url=${news.url}">
		
			<img th:if="${news.imageUrl}" th:src="${news.imageUrl}"
				class="news-feed-img" />

			<div class="news-feed-title" th:text="${news.title}">æ¨™é¡Œ</div>

			<div class="news-feed-desc" th:text="${news.description}">æ‘˜è¦</div>

			<div class="news-feed-time"
				th:text="${#temporals.format(news.publishedAt, 'yyyy-MM-dd HH:mm')}">æ™‚é–“</div>


			<div class="news-feed-content" th:utext="${news.content}"></div>

			<div class="news-feed-actions">
				<button class="btn btn-sm btn-outline-primary toggle-content-btn">é–±è®€å…¨æ–‡</button>
				<button class="btn btn-sm favorite-btn btn-outline-success"
					th:text="'ğŸ’™ æ”¶è—'" th:attr="data-id=${news.id}"></button>
				<button class="btn btn-sm btn-outline-danger remove-from-cart-btn"
					th:attr="data-id=${news.id}">ç§»é™¤</button>
			</div>
		</div>
	</div>
	</div>
	<!-- âœ… AI åŠ©ç†å°è©±æ¡† -->
	<div id="ai-chatbox">
		<div id="ai-chatbox-header">ğŸ¤– AI åŠ©ç†</div>
		<div id="ai-chatbox-messages">
			<div>
				<strong>AI:</strong> å—¨ï¼éœ€è¦å¹«å¿™å—ï¼Ÿ
			</div>
		</div>
		<div id="ai-chatbox-input">
			<input type="text" id="ai-user-input" placeholder="è¼¸å…¥è¨Šæ¯..." />
			<button onclick="sendAiMessage()">é€å‡º</button>
		</div>
	</div>

	<button id="ai-assistant-button" onclick="toggleChatbox()">ğŸ’¬
		æœ‰äº‹å• AI</button>
</body>
</html>