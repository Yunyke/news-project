<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>üì∞ Êñ∞ËÅûÁâÜ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
<style>
.ai-reply-block {
  background-color: #eef3ff;
  border-left: 4px solid #0d6efd;
  padding: 8px 12px;
  border-radius: 6px;
  margin: 6px 0;
  font-size: 0.95rem;
  line-height: 1.5;
}

.ai-label {
  font-weight: bold;
  color: #0d6efd;
}

.ai-content {
  margin-top: 4px;
  color: #333;
  white-space: pre-line;
}


.news-feed-actions .btn.btn-outline-secondary {
    margin-left: auto;
}
.news-feed-content.show-content {
  display: block;
}
#ai-assistant-button {
	position: fixed;
	bottom: 20px;
	right: 20px;
	z-index: 999;
	background-color: #0d6efd;
	color: white;
	border: none;
	border-radius: 50px;
	padding: 12px 18px;
	font-size: 0.95rem;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
	cursor: pointer;
	transition: background-color 0.2s ease;
}

#ai-assistant-button:hover {
	background-color: #0056b3;
}

#ai-chatbox {
	position: fixed;
	bottom: 80px;
	right: 20px;
	width: 500px;
	height: 600px;
	max-height: 400px;
	background-color: #ffffff;
	border-radius: 16px;
	box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
	display: none;
	flex-direction: column;
	overflow: hidden;
	z-index: 998;
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

#ai-chatbox-header {
	background-color: #0d6efd;
	color: #fff;
	padding: 12px;
	font-weight: bold;
	font-size: 1rem;
}

#ai-chatbox-messages {
	flex: 1;
	padding: 16px;
	font-size: 1.2rem;
	overflow-y: auto;
	background-color: #f9f9f9;
}

#ai-chatbox-messages div {
	margin-bottom: 0.75rem;
	line-height: 1.4;
}

#ai-chatbox-messages div strong {
	color: #0d6efd;
}

#ai-chatbox-input {
	display: flex;
	border-top: 1px solid #ddd;
	background: #fff;
}

#ai-chatbox-input input {
	flex: 1;
	border: none;
	padding: 10px;
	font-size: 0.9rem;
	outline: none;
	background-color: #f7f7f7;
}

#ai-chatbox-input button {
	border: none;
	background-color: #0d6efd;
	color: white;
	padding: 10px 14px;
	cursor: pointer;
	font-size: 0.9rem;
	transition: background-color 0.2s ease;
}

#ai-chatbox-input button:hover {
	background-color: #0056b3;
}

#sidebar-nav {
	position: fixed;
	top: 80px;
	left: 80px;
	width: 400px;
	max-height: 80vh;
	overflow-y: auto;
	padding: 1rem;
	background-color: #fff;
	border-radius: 12px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	font-size: 0.95rem;
	z-index: 100;
}

#sidebar-nav h5 {
	font-weight: bold;
	font-size: 1rem;
	margin-bottom: 0.75rem;
}

.sidebar-list {
	list-style: none;
	padding: 0;
	margin: 0;
}

.sidebar-item {
	display: flex;
	align-items: center;
	margin-bottom: 0.5rem;
}

.sidebar-item .item-index {
	flex-shrink: 0;
	width: 2em;
	text-align: right;
	margin-right: 0.5rem;
	color: #555;
}

.sidebar-item a {
	display: inline-block;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	max-width: 320px;
	color: #333;
	text-decoration: none;
}

.sidebar-item a:hover {
	text-decoration: underline;
}

.sidebar-item a.active {
	font-weight: bold;
	color: #0d6efd;
}

body {
	background: #f0f2f5;
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
	margin: 0;
	padding: 0;
}

.feed-container {
	max-width: 720px;
	margin: 0 auto;
	padding: 1.5rem 1rem;
}

.news-feed-card {
	background-color: #fff;
	border-radius: 12px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
	margin-bottom: 1.5rem;
	padding: 1rem 1.25rem;
	transition: box-shadow 0.2s ease-in-out;
}

.news-feed-card:hover {
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.news-feed-title {
	font-size: 1.25rem;
	font-weight: bold;
	color: #1c1e21;
	margin-bottom: 0.5rem;
}

.news-feed-img {
	width: 100%;
	max-height: 360px;
	object-fit: cover;
	border-radius: 10px;
	margin: 0.75rem 0;
}

.news-feed-desc {
	font-size: 1rem;
	color: #333;
	line-height: 1.5;
	margin-bottom: 0.75rem;
}

.news-feed-time {
	font-size: 0.85rem;
	color: #777;
}

.news-feed-content {
	display: none;
	margin-top: 0.75rem;
	white-space: pre-wrap;
	color: #333;
	font-size: 0.95rem;
	line-height: 1.6;
}

.news-feed-actions {
	display: flex;
	gap: 0.5rem;
	margin-top: 0.75rem;
}

@media ( max-width : 576px) {
	.news-feed-card {
		padding: 1rem;
	}
	.news-feed-title {
		font-size: 1.1rem;
	}
	.news-feed-desc {
		font-size: 0.95rem;
	}
}

/* Êî∂ËóèÊ∏ÖÂñÆ */
#favorite-list {
	position: fixed;
	top: 80px;
	right: 80px;
	width: 320px;
	max-height: 80vh;
	overflow-y: auto;
	padding: 1rem;
	background-color: #fff;
	border-radius: 12px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	font-size: 0.95rem;
	z-index: 100;
}

#favorite-list h5 {
	font-weight: bold;
	font-size: 1rem;
	margin-bottom: 0.75rem;
}

#favorite-list .sidebar-item {
	display: flex;
	align-items: center;
	margin-bottom: 0.5rem;
}

#favorite-list .sidebar-item a {
	display: inline-block;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	max-width: 280px;
	color: #333;
	text-decoration: none;
}

#favorite-list .sidebar-item a:hover {
	text-decoration: underline;
}

.card-remove-button {
	display: flex;
	justify-content: flex-end;
	margin-top: 1rem;
	margin-left: auto;
	padding-left: 1rem;
}

.custom-auth-btn { 
	background-color: transparent !important;
	border: 1px solid white;
	color: black !important;
	transition: all .3s ease;
} 
.custom-auth-btn:hover { 
	background-color: white !important;
	color: black !important;
}
#favorite-list .sidebar-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
}

#favorite-list .sidebar-item a {
  flex-grow: 1;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
#favorite-list .sidebar-item button {
  flex-shrink: 0;
}</style>
</head>

<body th:attr="data-user-id=${userId}" id="user-cart">

	<div
		style="position: absolute; top: 5px; right: 20px; z-index: 1050; background-color: #f8f9fa; padding: 5px 10px; border-radius: 8px; color: #6c757d;">
		<a class="btn btn-sm btn-outline-light me-2 custom-auth-btn" href="/">ÂõûÈ¶ñÈ†Å</a>
		<a class="btn btn-sm btn-outline-light custom-auth-btn" href="/logout">ÁôªÂá∫</a>
	</div>

	<!-- Êî∂ËóèÊ∏ÖÂñÆ -->
	<nav id="favorite-list">
		<h5>‚≠ê Êî∂ËóèÊ∏ÖÂñÆ</h5>
		<ul class="sidebar-list" id="favorite-list-ul">
			
		</ul>
	</nav>

	<!-- Â∑¶ÂÅ¥ÁõÆÈåÑ -->
	<nav id="sidebar-nav">
		
	</nav>

	<main class="feed-container">
		<h1 class="text-center mb-4">üì∞ ÊàëÁöÑÊñ∞ËÅûÁâÜ</h1>

		<div id="cart-content">	</div>
	</main>

	<script>function loadFavoriteList(userId) {
		  fetch(`/favorites?userId=${userId}`)
		    .then(res => res.json())
		    .then(favorites => {
		      const favList = document.getElementById("favorite-list-ul");
		      favList.innerHTML = ""; // Ê∏ÖÁ©∫ÂÜçÈáçÊñ∞Ê∏≤Êüì

		      favorites.forEach(item => {
		          const li = document.createElement("li");
		          li.className = "sidebar-item d-flex justify-content-between align-items-center";
		          li.setAttribute("data-news-id", item.newsId);
				
		        const link = document.createElement("a");
		        link.href = item.url || "#";  
		        link.target = "_blank";       
		        link.textContent = item.title || "Êú™ÂëΩÂêçÊñ∞ËÅû";
		        link.title = item.title;
				
		        const removeBtn = document.createElement("span");
		        removeBtn.textContent = "‚ùå ";
		        removeBtn.style.cursor = "pointer";
		        removeBtn.title = "ÁßªÈô§Êî∂Ëóè";
		        removeBtn.classList.add("text-danger", "me-1");

		        removeBtn.onclick = () => {
		          if (!confirm("Á¢∫ÂÆöË¶ÅÁßªÈô§ÈÄôÂâáÊî∂ËóèÂóéÔºü")) return;

		          fetch(`/favorites/${item.newsId}?userId=${userId}`, {
		            method: "DELETE"
		          })
		          .then(res => {
		            if (!res.ok) throw new Error("ÁßªÈô§Â§±Êïó");
		            li.remove();
		            console.log(`üóëÔ∏è Â∑≤ÁßªÈô§Êî∂ËóèÔºö${item.newsId}`);
		            loadCart(userId); 
		          })
		          .catch(err => {
		            console.error("‚ùå ÁßªÈô§Êî∂ËóèÂ§±Êïó", err);
		            alert("ÁßªÈô§Êî∂ËóèÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶");
		          });
		        };

		        const textWrap = document.createElement("div");
		        textWrap.className = "text-truncate";
		        textWrap.appendChild(link);

		        li.appendChild(textWrap);
		        li.appendChild(removeBtn);
		        favList.appendChild(li);
		      });
		    })
		    .catch(err => {
		      console.error("‚ùå ÁÑ°Ê≥ïËºâÂÖ•Êî∂ËóèÊ∏ÖÂñÆ", err);
		    });
		}
function syncCartToServer() {
	  const ids = JSON.parse(localStorage.getItem("newsCart") || "[]");

	  if (!Array.isArray(ids) || ids.length === 0) return;

	 
	  fetch(`/api/cart/users/${userId}/bulk`, {
	 
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify({ newsIds: ids })
	  })
	  .then(res => {
	    if (!res.ok) throw new Error("ÂêåÊ≠•Â§±Êïó");
	    return res.text();
	  })
	  .then(msg => console.log("‚úÖ Ë≥ºÁâ©ËªäÂêåÊ≠•ÂÆåÊàê"))
	  
	  .catch(err => console.error("‚ùå Ë≥ºÁâ©ËªäÂêåÊ≠•ÈåØË™§", err));
	}
function fetchCartFromServer(userId) {
	  return fetch(`/api/cart/users/${userId}/cart`)
	    .then(res => {
	      if (!res.ok) throw new Error("‚ùå ÁÑ°Ê≥ïÂèñÂæó‰º∫ÊúçÂô®Êî∂ËóèÊ∏ÖÂñÆ");
	      return res.json();
	    });
	}

const userCartEl = document.getElementById("user-cart");
const userId = parseInt(document.getElementById("user-cart").dataset.userId, 10);

if (!userId) {
	  console.warn("‚ö†Ô∏è ÁÑ°Ê≥ïÂèñÂæó userIdÔºåË´ãÁ¢∫Ë™çÁî®Êà∂Â∑≤ÁôªÂÖ•Êàñ body Ê®ôÁ±§ÊúâË®≠ÁΩÆ data-user-id");
	}
function loadCart(userId) {
	  const ids = JSON.parse(localStorage.getItem("newsCart") || "[]")
	              .filter(id => Number.isInteger(id) && id > 0);

	  if (ids.length === 0) {
	    document.getElementById("cart-content").innerHTML = `
	      <p class="text-center text-muted mt-5">üì≠ Êñ∞ËÅûÊ∏ÖÂñÆÁ©∫Á©∫ÁöÑ~</p>`;
	    return;
	  }

	  fetch("/cart/load", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify(ids)
	  })
	  .then(res => res.text())
	  .then(html => {
	    document.getElementById("cart-content").innerHTML = html;

    

	    document.querySelectorAll(".favorite-btn").forEach(btn => {
	        btn.addEventListener("click", function () {
	          const newsId = this.dataset.id;
	          const self = this;
	          

	         // fetch(`/favorites/${newsId}?userId=${window.USER_SESSION.userId}`, { method: "POST" })
	          fetch(`/favorites/${newsId}?userId=${userId}`, { method: "POST" })
	          .then(res => {
	        	    if (!res.ok) {
	        	        throw new Error(`HTTP ${res.status} - Êî∂ËóèÂ§±Êïó`);
	        	      }
	        	      return res.json();
	        	    })
	          .then(data => {
	            if (data.favorited !== undefined) {
	              const icon = data.favorited ? "‚ù§Ô∏è Â∑≤Êî∂Ëóè" : "üíô Êî∂Ëóè";
	              self.innerHTML = icon;
	              self.classList.toggle("btn-outline-success", !data.favorited);
	              self.classList.toggle("btn-outline-danger", data.favorited);

	             
	              const card = self.closest(".news-feed-card");
	              const title = card.querySelector(".news-feed-title")?.textContent || "Êú™ÂëΩÂêçÊñ∞ËÅû";
	              const url = card.getAttribute("data-url") || "#";
	              const id = card.getAttribute("id");
	              const favList = document.getElementById("favorite-list-ul");

	              if (data.favorited) {
	                const li = document.createElement("li");
	                li.className = "sidebar-item";
	                li.setAttribute("data-news-id", newsId);

	                const link = document.createElement("a");
	                link.href = url;                    
	                link.target = "_blank";             
	                link.textContent = title;
	                link.title = title;
	                
	                

	                const removeBtn = document.createElement("span");
	                removeBtn.textContent = "‚ùå ";
	                removeBtn.style.cursor = "pointer";
	                removeBtn.title = "ÁßªÈô§Êî∂Ëóè";
	                removeBtn.classList.add("text-danger", "me-1");

	                removeBtn.onclick = () => {
	                  if (!confirm("Á¢∫ÂÆöË¶ÅÁßªÈô§ÈÄôÂâáÊî∂ËóèÂóéÔºü")) return;

	                  fetch(`/favorites/${newsId}?userId=${userId}`, { method: "DELETE" })
	                    .then(res => {
	                      if (!res.ok) throw new Error("ÁßªÈô§Â§±Êïó");
	                      li.remove();
	                      console.log(`üóëÔ∏è Â∑≤ÁßªÈô§Êî∂ËóèÔºö${newsId}`);
	                      loadCart(userId);
	                    })
	                    .catch(err => {
	                      console.error("‚ùå ÁßªÈô§Êî∂ËóèÂ§±Êïó", err);
	                      alert("ÁßªÈô§Êî∂ËóèÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶");
	                    });
	                };

	                const textWrap = document.createElement("div");
	                textWrap.className = "text-truncate";
	                textWrap.appendChild(link);

	                li.appendChild(textWrap);
	                li.appendChild(removeBtn);
	                favList.appendChild(li);
	              } else {
	                const itemToRemove = favList.querySelector(`li[data-news-id="${newsId}"]`);
	                if (itemToRemove) itemToRemove.remove();
	              }
	            }
	          })
	          .catch(err => {
	            console.error("Êî∂ËóèÂ§±Êïó", err);
	            alert("‚ö†Ô∏è Êî∂ËóèÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶");
	          });
	        });
	      });

    // ÁßªÈô§ÁÑ°ÊïàID
    const existingIds = Array.from(document.querySelectorAll(".remove-from-cart-btn"))
      .map(btn => parseInt(btn.dataset.id));

    let cartIds = JSON.parse(localStorage.getItem("newsCart") || "[]");
    const filtered = cartIds.filter(id => existingIds.includes(id));

    if (filtered.length !== cartIds.length) {
      localStorage.setItem("newsCart", JSON.stringify(filtered));
      console.warn("üßπ Â∑≤Âæû localStorage Ê∏ÖÈô§ÁÑ°ÊïàÊñ∞ËÅû IDÔºö", cartIds.filter(id => !existingIds.includes(id)));
    }

    // Â∑¶ÂÅ¥ÁõÆÈåÑ
    const sidebar = document.getElementById("sidebar-nav");
    sidebar.innerHTML = "<h5>üìë Êñ∞ËÅûÊ∏ÖÂñÆ</h5><ul class='sidebar-list'></ul>";
    const list = sidebar.querySelector(".sidebar-list");

    document.querySelectorAll(".news-feed-card").forEach((card, index) => {
      const title = card.querySelector(".news-feed-title")?.textContent || `Êñ∞ËÅû ${index + 1}`;
      const id = `news-item-${index}`;
      card.setAttribute("id", id);

      const li = document.createElement("li");
      li.className = "sidebar-item";

      const number = document.createElement("span");
      number.className = "item-index";
      number.textContent = `${index + 1}.`;

      const link = document.createElement("a");
      link.href  = `#${card.id}`;  
      link.textContent = title;
      link.title = title;

      li.appendChild(number);
      li.appendChild(link);
      list.appendChild(li);
    });

    // ÁßªÈô§ÊåâÈàï
    document.querySelectorAll(".remove-from-cart-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        const id = parseInt(this.dataset.id);
        let cart = JSON.parse(localStorage.getItem("newsCart") || "[]");
        cart = cart.filter(item => item !== id);
        localStorage.setItem("newsCart", JSON.stringify(cart));
        fetch(`/api/cart/users/${userId}/cart/${id}`, {
            method: "DELETE"
          }).catch(err => console.error("Âà™Èô§ÂæåÁ´Ø cart Â§±Êïó", err));

          loadCart(userId); // ÈáçÊñ∞ËºâÂÖ•Áï´Èù¢
        });
    });

    // Â±ïÈñãÂÖ®Êñá
    document.querySelectorAll(".toggle-content-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        const content = this.closest(".news-feed-card").querySelector(".news-feed-content");
        const isShown = content.style.display === "block";
        content.style.display = isShown ? "none" : "block";
        this.textContent = isShown ? "Èñ±ËÆÄÂÖ®Êñá" : "Êî∂Ëµ∑ÂÖ®Êñá";
      });
    });
  });
}

// AI ËÅäÂ§©Ë¶ñÁ™ó
function toggleChatbox() {
  const chatbox = document.getElementById("ai-chatbox");
  chatbox.style.display = (chatbox.style.display === "none" || chatbox.style.display === "") ? "flex" : "none";
}

// ÂÇ≥ÈÄÅË®äÊÅØÂà∞ AI ‰∏¶È°ØÁ§∫ÂõûË¶Ü
async function sendAiMessage() {
  const input = document.getElementById("ai-user-input");
  const msg = input.value.trim();
  if (!msg) return;

  const messages = document.getElementById("ai-chatbox-messages");

  const userMsg = document.createElement("div");
  userMsg.innerHTML = `<strong>‰Ω†:</strong> ${msg}`;
  messages.appendChild(userMsg);
  input.value = "";

  const aiReply = document.createElement("div");
  aiReply.innerHTML = `<strong>AI:</strong> ‚è≥ ÂõûË¶Ü‰∏≠...`;
  messages.appendChild(aiReply);
  messages.scrollTop = messages.scrollHeight;

  try {
    const res = await fetch("/api/openai/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: msg })
    });

    const reply = await res.text(); 
    aiReply.innerHTML = `<strong>AI:</strong> ${reply}`;
  } catch (err) {
    console.error("‚ùå AI ÂõûË¶ÜÈåØË™§", err);
    aiReply.innerHTML = `<strong>AI:</strong> ‚ùå ÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶`;
  }

  messages.scrollTop = messages.scrollHeight;
}


document.addEventListener("DOMContentLoaded", async () => {
  const userCartEl = document.getElementById("user-cart");
  const userId = parseInt(userCartEl?.dataset.userId, 10);

  if (!userId) {
    console.warn("‚ö†Ô∏è Ê≤íÊäìÂà∞ userIdÔºåÁôªÂÖ•‰∫ÜÂóéÔºü");
    return;
  }

  try {
    
    const serverCart = await fetchCartFromServer(userId);

    // Êõ¥Êñ∞ localStorage
    localStorage.setItem("newsCart", JSON.stringify(serverCart));

    // ËºâÂÖ•Áï´Èù¢‰∏¶ÂêåÊ≠•Ë≥áÊñô
    syncCartToServer(userId); 
    loadCart(userId);
    loadFavoriteList(userId); 
  } catch (err) {
    console.error("‚ùå ÂàùÂßãÂêåÊ≠•Êî∂ËóèÂ§±ÊïóÔºö", err);
  }
  toggleChatbox();
 

  // Á∂ÅÂÆö AI Ëº∏ÂÖ• Enter Âø´Êç∑Èçµ
  const aiInput = document.getElementById("ai-user-input");
  if (aiInput) {
    aiInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        sendAiMessage();
      }
    });
  }
});

document.addEventListener("DOMContentLoaded", () => {
	 

	  // ÁôªÂá∫Ê∏ÖÈô§ localStorage
	  const logoutBtn = document.querySelector('a[href="/logout"]');
	  if (logoutBtn) {
	    logoutBtn.addEventListener("click", function (e) {
	      e.preventDefault();
	      console.log("üö™ [cart.html] ‰ΩøÁî®ËÄÖÁôªÂá∫ÔºåÊ∏ÖÈô§ localStorage.newsCart");
	      localStorage.removeItem("newsCart");
	      window.location.href = "/logout";
	    });
	  }
	});
	
document.addEventListener("click", function (e) {
  if (e.target && e.target.textContent.includes("AI ÈáçÈªûÊï¥ÁêÜ")) {
    const card = e.target.closest(".news-feed-card");
    const contentEl = card.querySelector(".news-feed-content");

    if (!contentEl) {
      alert("‚ùå Êâæ‰∏çÂà∞Êñ∞ËÅûÂÖßÂÆπ");
      return;
    }

    const contentText = contentEl.innerText.trim();
    if (!contentText) {
      alert("‚ùó Ë©≤Êñ∞ËÅûÊ≤íÊúâÂÖßÂÆπÂèØ‰ª•ÊëòË¶Å");
      return;
    }

 
    const chatbox = document.getElementById("ai-chatbox");
    if (chatbox.style.display === "none" || chatbox.style.display === "") {
      chatbox.style.display = "flex";
    }

    // ÈÄÅÂá∫Êñ∞ËÅûÂÖßÂÆπÁµ¶ AI
    sendAiContentToChat(contentText);
  }
});


function sendAiContentToChat(contentText) {
  const messages = document.getElementById("ai-chatbox-messages");

  const userMsg = document.createElement("div");
  userMsg.innerHTML = `<strong>‰Ω†:</strong> ÈáçÈªûÊï¥ÁêÜ‰ª•‰∏ãÊñ∞ËÅûÔºö<br><div style="font-size: 0.85rem; color: #555; margin-top: 4px;">${contentText}</div>`;
  messages.appendChild(userMsg);

  const aiReply = document.createElement("div");
  aiReply.innerHTML = `<strong>AI:</strong> ‚è≥ Ê≠£Âú®ÂàÜÊûê‰∏≠...`;
  messages.appendChild(aiReply);
  messages.scrollTop = messages.scrollHeight;

  fetch("/api/openai/ask", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },	 
	    body: JSON.stringify({ message: contentText })
	  })
	    .then(res => res.text())
	    .then(reply => {
	    	aiReply.innerHTML = `
	    		  <div class="ai-reply-block">
	    		    <strong class="ai-label">AI:</strong>
	    		    <div class="ai-content">${reply.replace(/\n/g, "<br>")}</div>
	    		  </div>`;
	      messages.scrollTop = messages.scrollHeight;
	    })
	    .catch(err => {
	      console.error("‚ùå AI ÂõûË¶ÜÈåØË™§", err);
	      aiReply.innerHTML = `<strong>AI:</strong> ‚ùå ÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶`;
	    });
	}

</script>

	<div th:fragment="cartFragment">
		<script th:inline="javascript">
	console.log("User ID is:", userId);
	
	
</script>

		<div th:each="news : ${cartNews}" class="news-feed-card" th:attr="data-url=${news.url}">
		
			<img th:if="${news.imageUrl}" th:src="${news.imageUrl}"
				class="news-feed-img" />

			<div class="news-feed-title" th:text="${news.title}">Ê®ôÈ°å</div>

			<div class="news-feed-desc" th:text="${news.description}">ÊëòË¶Å</div>

			<div class="news-feed-time"
				th:text="${#temporals.format(news.publishedAt, 'yyyy-MM-dd HH:mm')}">ÊôÇÈñì</div>


			<div class="news-feed-content" th:utext="${news.content}"></div>

			<div class="news-feed-actions">
    <button class="btn btn-sm btn-outline-primary toggle-content-btn">Èñ±ËÆÄÂÖ®Êñá</button>
    <button class="btn btn-sm favorite-btn btn-outline-success"
        th:text="'üíô Êî∂Ëóè'" th:attr="data-id=${news.id}"></button>
    <button class="btn btn-sm btn-outline-danger remove-from-cart-btn"
        th:attr="data-id=${news.id}">ÁßªÈô§</button>    
   
    <button class="btn btn-sm btn-outline-secondary ms-auto">AI ÈáçÈªûÊï¥ÁêÜ</button>
</div>
	</div>
	</div>
	<!-- AI Âä©ÁêÜÂ∞çË©±Ê°Ü -->
	<div id="ai-chatbox">
		<div id="ai-chatbox-header">ü§ñ AI Âä©ÁêÜ</div>
		<div id="ai-chatbox-messages">
			<div>
				<strong>AI:</strong> Ë´ãÈÅ∏ÊìáÊñ∞ËÅû...
			</div>
			<div id="ai-chatbox-input">
			
		</div>
		</div>
		
	</div>
	
</body>
</html>