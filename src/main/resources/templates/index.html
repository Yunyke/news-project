<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head translate="no">
<meta charset="UTF-8">
<title th:text="${title}">Daily News</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap"
	rel="stylesheet">
<link rel="stylesheet" th:href="@{css/index.css}">
<style>

</style>

</head>
<body>
	<script th:inline="javascript">
  window.USER_SESSION = {
    isLoggedIn: /*[[${session.name != null}]]*/ false,
    userId: /*[[${session.userId}]]*/ null,
    name: /*[['${session.name}']]*/ ''
  };
  window.IS_LOGGED_IN = /*[[${session.name != null}]]*/ false;
</script>
	<div id="google_translate_element" style="display: none;"></div>




	<!-- ğŸ”µ é é¢ä¸»æ¨™é¡Œ -->
	<div class="header-title notranslate" translate="no">Daily News</div>

	<!-- ğŸ”µ å°è¦½åˆ— -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark mt-3 mb-4">
		<div class="container-fluid">
			<a class="navbar-brand" href="#" translate="no">Home</a>
			<button class="navbar-toggler" type="button"
				data-bs-toggle="collapse" data-bs-target="#navbarNav">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
					<li class="nav-item"><a class="nav-link active" href="#">Top30</a></li>

					<li class="nav-item"><a class="nav-link" href="#">CNN</a></li>
					<li class="nav-item"><a class="nav-link" href="#">BBC</a></li>
					<li class="nav-item"><a class="nav-link" href="#">NHK</a></li>
				</ul>
				<a href="#"
					class="btn btn-warning position-fixed bottom-0 end-0 m-4"
					style="z-index: 999;" onclick="handleViewCartClick()"> ğŸ“°
					æŸ¥çœ‹æ–°èæ¸…å–® <span id="cart-count" class="badge bg-dark ms-1"></span>
				</a>
				<ul class="navbar-nav ms-auto">


					<form class="d-flex ms-auto align-items-center"
						th:action="@{/search}" method="get">
						<!-- ğŸ”¤ Label -->


						<!-- ğŸ”˜ æŒ‰éˆ• + è¼¸å…¥æ¡† -->
						<div class="input-group input-group-sm" style="max-width: 250px;">
							<!-- æœå°‹æŒ‰éˆ• -->
							<button class="btn btn-outline-light" type="submit">æœå°‹</button>

							<!-- è¼¸å…¥æ¡† -->
							<input type="text" name="keyword"
								class="form-control white text-black  border-0"
								placeholder="è¼¸å…¥é—œéµå­—â€¦" aria-label="Search">
						</div>
					</form>

				</ul>
			</div>
		</div>
	</nav>
	<!-- âœ… å°šæœªç™»å…¥æ™‚é¡¯ç¤ºç™»å…¥/è¨»å†Š -->
	<div th:if="${session.name == null}"
		style="position: absolute; top: 5px; right: 20px; z-index: 1050; background-color: #f8f9fa; padding: 5px 10px; border-radius: 8px; color: #6c757d;">
		<a class="btn btn-sm btn-outline-light me-2 custom-auth-btn"
			th:href="@{/login}" style="color: #6c757d;">ç™»å…¥</a> <a
			class="btn btn-sm btn-outline-light custom-auth-btn"
			th:href="@{/register}" style="color: #6c757d;">è¨»å†Š</a>
	</div>

	<!-- âœ… å·²ç™»å…¥æ™‚é¡¯ç¤ºæ­¡è¿è©å’Œç™»å‡º -->
	<div th:if="${session.name != null}"
		style="position: absolute; top: 5px; right: 20px; z-index: 1050; background-color: #f8f9fa; padding: 5px 10px; border-radius: 8px; color: #6c757d;">
		<span class="text-warning me-2"> æ­¡è¿ï½<strong
			th:text="${session.name}" style="color: #6c757d;">ä½¿ç”¨è€…</strong>
		</span> <a id="logoutBtn" class="btn btn-sm btn-outline-light me-2" th:href="@{/logout}"
			style="color: #6c757d;">ç™»å‡º</a>
	</div>
	<!-- ğŸ”µ æ–°èå¡ç‰‡å€ -->
	<div class="grid-container">
		<!-- ä¸‰å€‹å€å¡Šï¼šCNNã€BBC å’Œ NHK -->
		<div class="news-grid">


			<div class="news-section">
				<h2 class="news-section-title mb-3" translate="no">CNN</h2>

				<div th:each="news : ${cnnNewsList}"
					th:if="${news != null and news.title != null and news.title != ''}"
					class="news-card  ">

					<button class="btn btn-sm btn-outline-primary add-to-cart-btn"
						th:attr="data-id=${news.id}">â•</button>
					<a th:href="${news.url}" target="_blank">
						<div style="display: flex;">
							<img th:if="${news.imageUrl != null}" th:src="${news.imageUrl}"
								class="news-img" />
							<div class="news-content">
								<h5 class="news-title" th:text="${news.title}"></h5>
								<p class="hover-description" th:text="${news.description}"></p>
								<p class="news-time"
									th:text="${#temporals.format(news.publishedAt, 'yyyy-MM-dd HH:mm')}"></p>
							</div>
						</div>
					</a>
				</div>


			</div>


			<!-- BBC News -->
			<div class="news-section">
				<h2 class="news-section-title mb-3" translate="no">BBC</h2>
				<div th:each="news : ${bbcNewsList}" class="news-card">

					<!-- åŠ å…¥æ¸…å–®ç”¨ä¸»éµ id å°±å¥½ -->
					<button class="btn btn-sm btn-outline-primary add-to-cart-btn"
						th:attr="data-id=${news.id}">â•</button>

					<!-- çµ±ä¸€ç”¨ url ï¼ï¼ Entity è£¡çš„å”¯ä¸€æ¬„ä½ -->
					<a th:href="${news.url}" target="_blank">
						<div style="display: flex">
							<img th:if="${news.imageUrl}" th:src="${news.imageUrl}"
								class="news-img" />

							<div class="news-content">
								<h5 class="news-title" th:text="${news.title}">æ¨™é¡Œ</h5>

								<p class="hover-description" th:text="${news.description}">æ‘˜è¦</p>

								<!-- publishedAt âœ ç”¨ #temporals æ ¼å¼åŒ– -->
								<p class="news-time"
									th:text="${#temporals.format(news.publishedAt,'yyyy-MM-dd HH:mm')}">
								</p>
							</div>
						</div>
					</a>
				</div>
			</div>

			<!-- NHK News -->
			<div class="news-section">
				<h2 class="news-section-title mb-3" translate="no">NHK</h2>
				<div th:each="news : ${nhkNewsList}"
					th:if="${news.title != null and news.title != ''}"
					class="news-card">

					<!-- ğŸ”§ ç”¨ news.url.hashCode() è€Œéä¸å­˜åœ¨çš„ news.link -->
					<button class="btn btn-sm btn-outline-primary add-to-cart-btn"
						th:attr="data-id=${news.id}">â•</button>

					<!-- ğŸ”§ href æ”¹ç‚º news.url -->
					<a th:href="${news.url}" target="_blank"
						style="text-decoration: none; color: inherit;">
						<div style="display: flex; align-items: center;">
							<img th:if="${news.imageUrl != null}" th:src="${news.imageUrl}"
								class="news-img" alt="æ–°èåœ–ç‰‡" onerror="this.style.display='none'" />
							<div class="news-content">
								<h5 class="news-title" th:text="${news.title}">æ¨™é¡Œ</h5>
								<div class="hover-description" th:text="${news.description}">å…§å®¹</div>

								<!-- ğŸ”§ çµ±ä¸€ä½¿ç”¨ publishedAt æ™‚é–“æ ¼å¼ï¼ˆè‹¥æœ‰ï¼‰ -->
								<p class="text-muted news-time"
									th:text="${#temporals.format(news.publishedAt, 'yyyy-MM-dd HH:mm')}">æ—¥æœŸ</p>
							</div>
						</div>
					</a>
				</div>
			</div>



		</div>
	</div>

	</div>
	<script>
/* ==================== index.html â€“ è³¼ç‰©è»Šè…³æœ¬ ==================== */
document.addEventListener("DOMContentLoaded", async function () {

  /* ---------- 0. è‹¥å‰›ç™»å…¥å¼·åˆ¶æ¸…ç©º localStorage ---------- */
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get("resetCart") === "true") {
    console.log("ğŸ§¹ æ¸…é™¤ localStorage.newsCartï¼ˆå› ç™»å…¥ï¼‰");
    localStorage.removeItem("newsCart");
    
    

    // æŠŠ resetCart åƒæ•¸å¾ç¶²å€æ‹¿æ‰ï¼Œé¿å… F5 åˆåŸ·è¡Œä¸€æ¬¡
    const cleanUrl = window.location.origin + window.location.pathname;
    window.history.replaceState({}, document.title, cleanUrl);
  }

  /* ---------- 1. å…ˆå¾ localStorage å–ï¼›å¦‚æœå·²ç™»å…¥å†å‘å¾Œç«¯åŒæ­¥ ---------- */
  let cart = JSON.parse(localStorage.getItem("newsCart") || "[]");

  // ğŸ†• åªæœ‰ã€Œå·²ç™»å…¥ã€æ‰è·Ÿé›²ç«¯æ¯”å°æ¸…å–®
  if (window.IS_LOGGED_IN) {
    try {
      const res = await fetch(`/api/cart/users/${window.USER_SESSION.userId}/cart`);
      if (res.ok) {
        const serverIds = await res.json();     // [101, 102, 103â€¦]
        // ğŸ†• åˆä½µï¼ˆé¿å… localStorage å·²æœ‰çš„æ‰‹å‹•åŠ å…¥ï¼‰
        cart = Array.from(new Set([...cart, ...serverIds]));
        localStorage.setItem("newsCart", JSON.stringify(cart));
        console.log("â˜ï¸  å·²å¾ä¼ºæœå™¨åŒæ­¥æ¸…å–®ï¼š", serverIds);
      }
    } catch (err) {
      console.error("âš ï¸  é›²ç«¯æ¸…å–®è®€å–å¤±æ•—ï¼š", err);
    }
  }

  /* ---------- 2. æƒææ‰€æœ‰ã€Œâ•ã€æŒ‰éˆ•ï¼Œä¾ cart ç‹€æ…‹æ±ºå®šæ–‡å­— ---------- */
  document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
    const id   = parseInt(btn.dataset.id, 10);
    const card = btn.closest(".news-card");

    /* é è¨­ç‹€æ…‹ */
    if (cart.includes(id)) {
      card.classList.add("added-to-cart");
      btn.innerText = "âœ… å·²åŠ å…¥";
    }

    /* é»æ“Šäº‹ä»¶ */
    btn.addEventListener("click", function (event) {
      event.stopPropagation();

      /* æœªç™»å…¥ç›´æ¥æ“‹ä¸‹ */
      if (!window.IS_LOGGED_IN) {
        alert("è«‹å…ˆç™»å…¥æ‰èƒ½åŠ å…¥æ–°èæ¸…å–®ï¼");
        return;
      }

      const userId = window.USER_SESSION.userId;
      if (!userId) {
        alert("ç„¡æ³•è¾¨è­˜ä½¿ç”¨è€… IDï¼Œè«‹é‡æ–°ç™»å…¥");
        return;
      }

      /* --- åŠ å…¥ --- */
      if (!cart.includes(id)) {
        cart.push(id);
        card.classList.add("added-to-cart");
        btn.innerText = "âœ… å·²åŠ å…¥";

        fetch(`/api/cart/users/${userId}/cart`, {     // è·¯å¾‘ä¸è®Š
          method : "POST",
          headers: { "Content-Type": "application/json" },
          body   : JSON.stringify({ newsId: id })
        }).catch(err => console.error("åŠ å…¥æ¸…å–®å¤±æ•—ï¼š", err));

      /* --- ç§»é™¤ --- */
      } else {
        cart = cart.filter(itemId => itemId !== id);
        card.classList.remove("added-to-cart");
        btn.innerText = "â•";

        fetch(
          `/api/cart/users/${userId}/cart/${id}`,      // ğŸ”„ æ”¹ç”¨ RESTful è·¯å¾‘
          { method: "DELETE" }
        ).catch(err => console.error("ç§»é™¤æ¸…å–®å¤±æ•—ï¼š", err));
      }

      localStorage.setItem("newsCart", JSON.stringify(cart));
      updateCartCount();
    });
  });

  updateCartCount();  // åˆå§‹è¼‰å…¥æ›´æ–°å³ä¸‹è§’ badge

}); /* --- DOMContentLoaded end --- */

/* ---------- 3. å°å·¥å…·ï¼šæ›´æ–°å³ä¸‹è§’æ•¸å­— ---------- */
function updateCartCount() {
  const cart   = JSON.parse(localStorage.getItem("newsCart") || "[]");
  const badge  = document.getElementById("cart-count");
  if (badge) {
    badge.innerText = cart.length;
    badge.style.display = cart.length === 0 ? "none" : "inline-block";
  }
}

document.getElementById("logoutBtn")?.addEventListener("click", function (e) {
	  e.preventDefault(); // é˜²æ­¢é è¨­è·³è½‰

	  // ğŸ”¥ æ¸…é™¤æœ¬åœ°å„²å­˜
	  console.log("ğŸšª ä½¿ç”¨è€…ç™»å‡ºï¼Œæ¸…é™¤ localStorage.newsCart");
	  localStorage.removeItem("newsCart");
	  updateCartCount();
	  // â¡ï¸ ç„¶å¾Œå°å‘å¾Œç«¯ logout URL
	  window.location.href = "/logout";
	});

/* ---------- 4. æŸ¥çœ‹æ–°èæ¸…å–® ---------- */
function handleViewCartClick() {
  if (!window.IS_LOGGED_IN) {
    alert("è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹æ–°èæ¸…å–®ï¼");
    return;
  }
  
  
  window.location.href = "/cart";
}
</script>

</body>
</html>