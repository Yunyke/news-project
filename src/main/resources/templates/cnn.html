<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>CNN 最新新聞</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
	<link rel="stylesheet" th:href="@{css/webstyle.css}">
</head>

<style>

.news-grid {
	display: grid;
	grid-template-columns: repeat(3, 1fr);
	gap: 20PX 190px;
	align-items: start;
	max-width: 1400px;
	margin: 0 auto;
	padding: 0 20px;
}

.news-card {
	background-color: #f7f7f7;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	border-radius: 8px;
	cursor: pointer;
	display: flex;
	flex-direction: row;
	padding: 10px;
	position: relative;
	transition: background-color 0.3s ease;
	margin: 10px;
	height: 150px;
	width: 150%;
	max-width: none;
	margin-left: -13%;
}




.news-title {
	font-weight: 700;
	font-size: 1rem;
	margin: 0 0 8px 0;
	word-wrap: break-word;
	line-height: 1.2;
	overflow: visible;
	text-overflow: normal;
	white-space: normal;
	max-height: 2.4em;
	padding-right: 80px;
	padding-left: 2px;
}


.add-to-cart-btn {
	position: absolute;
	top: 10px;
	right: 10px;
	z-index: 10;
	font-size: 0.75rem;
	padding: 4px 10px;
	background-color: #ffffff;
	color: #333;
	border: 1px solid #aaa;
	border-radius: 20px;
	box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
	transition: all 0.2s ease;
}

.star-button {
	background: none;
	border: none;
	cursor: pointer;
	padding: 0;
}

.news-item {
	position: relative;
	padding: 1rem;
	border-bottom: 1px solid #ccc;
}

.star-form {
	position: absolute;
	top: 0.5rem;
	right: 0.5rem;
}

.star-button {
	position: absolute;
	top: 0;
	right: -24px;
	width: 32px;
	height: 36px;
	background-color: rgba(255, 105, 180, 0.6);
	border: none;
	border-top-right-radius: 8px;
	border-bottom-right-radius: 8px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 1rem;
	cursor: pointer;
	z-index: 1;
	box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.15);
	backdrop-filter: blur(2px);
	transition: transform 0.2s ease;
}

.star {
	color: white;
	transition: color 0.3s, transform 0.2s;
}

.star.filled {
	color: gray;
}

.cnn-card .news-title {
	font-size: 0.95rem;
	line-height: 1.2;
	margin: 0;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
	padding-right: 60px;
}

body {
	top: 0 !important;
}

.custom-auth-btn {
	background-color: transparent !important;
	border: 1px solid white;
	color: black !important;
	transition: all 0.3s ease;
}

.custom-auth-btn:hover {
	background-color: white !important;
	color: black !important;
}
</style>

<body>

	<div class="header-title notranslate" translate="no">Daily News</div>

	<nav class="navbar navbar-expand-lg navbar-dark bg-dark mt-3 mb-4">
		<div class="container-fluid">
			<a class="navbar-brand" href="/" translate="no">Home</a>
			<button class="navbar-toggler" type="button"
				data-bs-toggle="collapse" data-bs-target="#navbarNav">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
					<li class="nav-item"><a class="nav-link" href="/">Top30</a></li>
					<li class="nav-item"><a class="nav-link" href="/cnn">CNN</a></li>
					<li class="nav-item"><a class="nav-link" href="/bbc">BBC</a></li>
					<li class="nav-item"><a class="nav-link" href="/nhk">NHK</a></li>
				</ul>

				<ul class="navbar-nav ms-auto">
					<form class="d-flex ms-auto align-items-center"
						th:action="@{/search}" method="get">
						<div class="input-group input-group-sm" style="max-width: 250px;">
							<button class="btn btn-outline-light" type="submit">搜尋</button>
							<input type="text" name="keyword"
								class="form-control white text-black border-0"
								placeholder="輸入關鍵字…" aria-label="Search">
						</div>
					</form>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container-fluid px-4 mt-4"
		style="max-width: 1600px; margin: auto;">
		<h1 class="mb-4">CNN 新聞</h1>

		<div class="news-grid">
			<div th:each="news : ${newsList}"
				th:if="${news != null and news.title != null and news.title != ''}"
				class="news-card">

				<button class="btn btn-sm btn-outline-primary add-to-cart-btn"
					th:attr="data-id=${news.id}">➕</button>

				<a th:href="${news.url}" target="_blank"
					style="text-decoration: none;">
					<div style="display: flex;">
						<img th:if="${news.imageUrl != null}" th:src="${news.imageUrl}"
							class="news-img" />
						<div class="news-content">
							<h5 class="news-title" th:text="${news.title}">標題</h5>
							<p class="hover-description" th:text="${news.description}">摘要</p>
							<p class="news-time"
								th:text="${#temporals.format(news.publishedAt, 'yyyy-MM-dd HH:mm')}">時間</p>
						</div>
					</div>
				</a>
			</div>
		</div>
	</div>

	<a href="#" class="btn btn-warning position-fixed bottom-0 end-0 m-4"
		style="z-index: 999;" onclick="handleViewCartClick()"> 📰 查看新聞清單 <span
		id="cart-count" class="badge bg-dark ms-1"></span></a>

	<div th:if="${session.name == null}"
		style="position: absolute; top: 5px; right: 20px; z-index: 1050; background-color: #f8f9fa; padding: 5px 10px; border-radius: 8px; color: #6c757d;">
		<a class="btn btn-sm btn-outline-light me-2 custom-auth-btn"
			th:href="@{/login}" style="color: #6c757d;">登入</a> <a
			class="btn btn-sm btn-outline-light custom-auth-btn"
			th:href="@{/register}" style="color: #6c757d;">註冊</a>
	</div>

	<div th:if="${session.name != null}"
		style="position: absolute; top: 5px; right: 20px; z-index: 1050; background-color: #f8f9fa; padding: 5px 10px; border-radius: 8px; color: #6c757d;">
		<span class="text-warning me-2"> 歡迎～<strong
			th:text="${session.name}" style="color: #6c757d;">使用者</strong></span> <a
			id="logoutBtn" class="btn btn-sm btn-outline-light me-2"
			th:href="@{/logout}" style="color: #6c757d;">登出</a>
	</div>

	<script th:src="@{/js/cart.js}"></script>
	<script th:inline="javascript">
    window.USER_SESSION = {
      isLoggedIn: /*[[${session.name != null}]]*/ false,
      userId: /*[[${session.userId}]]*/ null,
      name: /*[['${session.name}']]*/ ''
    };
    window.IS_LOGGED_IN = /*[[${session.name != null}]]*/ false;
  </script>
	<script>
    document.addEventListener("DOMContentLoaded", async function () {
      if (!window.IS_LOGGED_IN) {
        localStorage.removeItem("newsCart");
      }

      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get("resetCart") === "true") {
        localStorage.removeItem("newsCart");
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      }

      let cart = JSON.parse(localStorage.getItem("newsCart") || "[]");

      if (window.IS_LOGGED_IN) {
        try {
          const res = await fetch(`/api/cart/users/${window.USER_SESSION.userId}/cart`);
          if (res.ok) {
            const serverIds = await res.json();
            cart = Array.from(new Set([...cart, ...serverIds]));
            localStorage.setItem("newsCart", JSON.stringify(cart));
          }
        } catch (err) {
          console.error("雲端清單讀取失敗：", err);
        }
      }

      document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
        const id = parseInt(btn.dataset.id, 10);
        const card = btn.closest(".news-card");

        if (cart.includes(id)) {
          card.classList.add("added-to-cart");
          btn.innerText = "✅ 已加入";
        }

        btn.addEventListener("click", function (event) {
          event.stopPropagation();
          if (!window.IS_LOGGED_IN) {
            alert("請先登入才能加入新聞清單！");
            return;
          }

          const userId = window.USER_SESSION.userId;
          if (!userId) {
            alert("無法辨識使用者 ID，請重新登入");
            return;
          }

          if (!cart.includes(id)) {
            cart.push(id);
            card.classList.add("added-to-cart");
            btn.innerText = "✅ 已加入";
            fetch(`/api/cart/users/${userId}/cart`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ newsId: id })
            });
          } else {
            cart = cart.filter(itemId => itemId !== id);
            card.classList.remove("added-to-cart");
            btn.innerText = "➕";
            fetch(`/api/cart/users/${userId}/cart/${id}`, { method: "DELETE" });
          }

          localStorage.setItem("newsCart", JSON.stringify(cart));
          updateCartCount();
        });
      });

      updateCartCount();
    });

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem("newsCart") || "[]");
      const badge = document.getElementById("cart-count");
      if (badge) {
        badge.innerText = cart.length;
        badge.style.display = cart.length === 0 ? "none" : "inline-block";
      }
    }

    document.getElementById("logoutBtn")?.addEventListener("click", function (e) {
      e.preventDefault();
      localStorage.removeItem("newsCart");
      updateCartCount();
      window.location.href = "/logout";
    });

    function handleViewCartClick() {
      if (!window.IS_LOGGED_IN) {
        alert("請先登入才能查看新聞清單！");
        return;
      }
      window.location.href = "/cart";
    }
  </script>

</body>
</html>
